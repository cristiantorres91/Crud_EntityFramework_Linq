# Crud_EntityFramework_Linq
Mantenimiento a Base de Datos Usando ENTITY FRAMEWORK Y LINQ en .NET

Si quieres una explicacion de como esta desarrollada esta aplicacion
Visita Mi Blog: http://cristiantorresalfaro.blogspot.com/2012/06/mantenimiento-bd-usando-entity.html


Siempre que desarrollamos aplicaciones que usan <span style="font-weight: bold;">bases</span> <span style="font-weight: bold;">de datos</span> nos vemos en la necesidad de <span style="font-weight: bold;">agregar</span>, <span style="font-weight: bold;">editar</span>, <span style="font-weight: bold;">eliminar</span> o <span style="font-weight: bold;">buscar registros</span> pues bien ahora veremos como hacer todas estas operaciones usando <span style="font-weight: bold;">entity framework </span>y<span style="font-weight: bold;"> linq</span>.<br /><br /><span style="font-weight: bold;">Para este ejemplo desarrolle una  aplicación en 2 capas y utilizo una base de datos llamada Database que tiene una tabla llamada Personas.</span><br /><br /><span style="font-weight: bold;">El ejemplo esta desarrollado con visual estudio 2010 en c# y vb.net</span><br /><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pf3PrQEyfmO0E8Mto1o7mbHCywAfJlKM60xK4_Vvep1KS4G3CkILLj2nROTiZAUG2KTuWXzoMlPT7EdA_iFlutg/1.jpg?psid=1" alt="Base Datos" width="550" /><br /></div><br />Lo primero que aremos es crear el<span style="font-weight: bold;"> modelo conceptual</span> de nuestra base de datos para eso agregamos un nuevo elemento y elegimos <span style="font-weight: bold;">entity data model</span> y seguimos los pasos necesarios para que el visual estudio nos cree nuestra clase y propiedades de nuestra tabla personas.<br /><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pA8Kj_9e2JI9SyRso2LnkV_p9Yaj5jVQkBcrJowgPiBqEj7lHSu7q8HvYNORDzPVjz2u8EkmeuNm3X3pFFVMfmg/2.jpg?psid=1" alt="Entity Data" /><br /></div><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pZPrYJoXU92gxu-ALnYdwAamm7CYODbpbFlZe-mJ1tmuMRZixvrftfehYtdntcvtt-uBqsa5UAsux-2EogKiFsA/3.jpg?psid=1" alt="Modelo" /><br /></div><br />Ahora que ya tenemos nuestro <span style="font-weight: bold;">modelo</span> entity de nuestra <span style="font-weight: bold;">tabla</span> creado empezaremos a programar todas las operaciones agregamos una clase llamada <span style="font-weight: bold;">Datos.cs </span>o<span style="font-weight: bold;"> Datos.vb</span>.<br /><br />Para cada operación crearemos un <span style="font-weight: bold;">métod</span>o comenzaremos con el <span style="font-weight: bold;">método</span> que recupera todos los <span style="font-weight: bold;">registros</span> de nuestra tabla.<br /><pre class="brush: csharp"><br />        public static List&lt;Personas&gt; CargarDatos()<br />        {<br />            using (DatabaseEntities bd = new DatabaseEntities())<br />            {<br />               var datos = (from p in bd.Personas select p).ToList();<br /><br />                return datos;<br />            }<br />        }</pre><br /><pre class="brush: vbnet">Public Shared Function CargarDatos() As List(Of Personas)<br />      Using bd As New DatabaseEntities()<br />          Dim datos = (From p In bd.Personas Select p).ToList()<br /><br />          Return datos<br />      End Using<br />  End Function</pre><br />Lo que hacemos es crear un <span style="font-weight: bold;">método</span> que <span style="font-weight: bold;">retornara</span> una <span style="font-weight: bold;">lista</span> de tipo <span style="font-weight: bold;">personas</span> y dentro del método creamos una instancia de nuestro <span style="font-weight: bold;">modelo</span> y con <span style="font-weight: bold;">linq</span> hacemos la consulta para que nos muestre todos los registros que hay en la tabla personas es como hacerle un <span style="font-weight: bold;">select</span> a toda la tabla.<br /><br />Ahora creamos el <span style="font-weight: bold;">método</span>  que nos servirá para <span style="font-weight: bold;">buscar registros</span> por medio del nombre.<br /><pre class="brush: csharp"><br />        public static List&lt;Personas&gt; Buscar(string nombre)<br />        {<br />            using (DatabaseEntities bd = new DatabaseEntities())<br />            {<br />                var buscar = (from p in bd.Personas<br />                              where p.Nombre.StartsWith(nombre)<br />                              select p).ToList();<br /><br />                return buscar;                <br />            }<br />        }</pre><br /><pre class="brush: vbnet">Public Shared Function Buscar(ByVal nombre As String) As List(Of Personas)<br />      Using bd As New DatabaseEntities()<br />          Dim busca = (From p In bd.Personas<br />                       Where p.Nombre.StartsWith(nombre)<br />                       Select p).ToList()<br /><br />          Return busca<br />      End Using<br />  End Function</pre><br />Como podemos ver es parecido al anterior lo único que cambia es la consulta <span style="font-weight: bold;">linq</span> como lo que queremos hacer es buscar registros por nombre aremos uso de<span style="font-weight: bold;"> where</span> para filtrar los registros por medio del <span style="font-weight: bold;">nombre</span> también hacemos uso de <span style="font-weight: bold;">StartsWith</span> que es algo similar al <span style="font-weight: bold;">like</span> de sql para que por ejemplo si escribimos la letra c se nos mostraran todos los registros que empiecen con la letra c.<br /><br />Ahora creemos el <span style="font-weight: bold;">método</span> que nos servirá para <span style="font-weight: bold;">agregar registros</span>.<br /><pre class="brush: csharp">public static void Agregar(string nombre, string apellido, int edad,string profesion)<br />      {<br />          using (DatabaseEntities bd = new DatabaseEntities())<br />          {<br />              bd.Personas.AddObject(new Personas { Nombre = nombre, Apellido = apellido, Edad = edad, Profesion = profesion });<br />              bd.SaveChanges();<br />          }<br />      }</pre><br /><pre class="brush: vbnet">Public Shared Sub Agregar(ByVal nombre As String, ByVal apellido As String, ByVal edad As Integer, ByVal profesion As String)<br />      Using bd As New DatabaseEntities()<br />          bd.Personas.AddObject(New Personas() With {.Nombre = nombre, .Apellido = apellido, .Edad = edad, .Profesion = profesion})<br />          bd.SaveChanges()<br />      End Using<br />  End Sub</pre><br />Lo que hacemos aquí es crear un <span style="font-weight: bold;">método</span> que recibirá los <span style="font-weight: bold;">parámetros</span> necesarios para agregar un registro, luego como en todos los métodos creamos una instancia de nuestro modelo y hacemos uso del método <span style="font-weight: bold;">AddObject</span> para agregar un un nuevo objeto(registro) de tipo persona y guardamos los datos en nuestra bd con el método <span style="font-weight: bold;">SaveChanges</span>.<br /><br />Ahora creamos el<span style="font-weight: bold;"> método</span> para <span style="font-weight: bold;">editar</span> los registros.<br /><pre class="brush: csharp">public static void Editar(int id,string nombre, string apellido, int edad, string profesion)<br />      {<br />          using (DatabaseEntities bd = new DatabaseEntities())<br />          {<br />              var editar = (from p in bd.Personas<br />                            where p.Id == id<br />                            select p).Single();<br /><br />              editar.Nombre = nombre;<br />              editar.Apellido = apellido;<br />              editar.Edad = edad;<br />              editar.Profesion = profesion;<br />              bd.SaveChanges();<br />          }<br />      }</pre><br /><pre class="brush: vbnet">Public Shared Sub Editar(ByVal id As Integer, ByVal nombre As String, ByVal apellido As String, ByVal edad As Integer, ByVal profesion As String)<br />      Using bd As New DatabaseEntities()<br />          Dim editar = (From p In bd.Personas<br />                        Where p.Id = id<br />                        Select p).Single()<br /><br />          editar.Nombre = nombre<br />          editar.Apellido = apellido<br />          editar.Edad = edad<br />          editar.Profesion = profesion<br />          bd.SaveChanges()<br />      End Using<br />  End Sub</pre><br />Al igual que el anterior creamos un <span style="font-weight: bold;">método</span> que recibirá los <span style="font-weight: bold;">parámetros</span> necesarios para editar un registro  y luego haciendo uso de <span style="font-weight: bold;">linq</span> hacemos una consulta para recuperar el registro a editar y le asignamos los nuevos valores.<br /><br />Ahora veremos el <span style="font-weight: bold;">método</span> que nos servirá para<span style="font-weight: bold;"> eliminar</span> un registro.<br /><pre class="brush: csharp">public static void Eliminar(int id)<br />      {<br />          using (DatabaseEntities bd = new DatabaseEntities())<br />          {<br />              var eliminar = (from p in bd.Personas<br />                              where p.Id==id<br />                              select p).Single();<br /><br />              bd.DeleteObject(eliminar);<br />              bd.SaveChanges();<br />          }<br />      }</pre><br /><pre class="brush: vbnet">Public Shared Sub Eliminar(ByVal id As Integer)<br />      Using bd As New DatabaseEntities()<br />          Dim eliminar = (From p In bd.Personas<br />                          Where p.Id = id<br />                          Select p).Single()<br /><br />          bd.DeleteObject(eliminar)<br />          bd.SaveChanges()<br />      End Using<br />  End Sub</pre><br />Creamos un<span style="font-weight: bold;"> método</span> que recibirá un <span style="font-weight: bold;">parámetro</span> que sera el<span style="font-weight: bold;"> id</span> por el cual eliminaremos el registro y haciendo uso de<span style="font-weight: bold;"> linq</span> recuperamos el registro por medio del id y luego eliminamos el registro con el método <span style="font-weight: bold;">DeleteObject</span>.<br /><br />Por ultimo crearemos un <span style="font-weight: bold;">método</span> que nos servirá para <span style="font-weight: bold;">cargar</span> en nuestro formulario de edición los datos del registro que queremos editar.<br /><pre class="brush: csharp">public static Personas ObtenerId(int id)<br />      {<br />          Personas persona = new Personas();<br />          using (DatabaseEntities bd = new DatabaseEntities())<br />          {<br />              var regis = (from p in bd.Personas<br />                            where p.Id==id<br />                            select p).Single();<br /><br />              persona.Id = regis.Id;<br />              persona.Nombre = regis.Nombre;<br />              persona.Apellido = regis.Apellido;<br />              persona.Edad = regis.Edad;<br /><br />              return persona;<br />          }<br />      }</pre><br /><pre class="brush: vbnet">Public Shared Function ObtenerId(ByVal id As Integer) As Personas<br />      Dim persona As New Personas()<br />      Using bd As New DatabaseEntities()<br />          Dim regis = (From p In bd.Personas<br />                       Where p.Id = id<br />                       Select p).Single()<br /><br />          persona.Id = regis.Id<br />          persona.Nombre = regis.Nombre<br />          persona.Apellido = regis.Apellido<br />          persona.Edad = regis.Edad<br /><br />          Return persona<br />      End Using<br />  End Function</pre><br />Lo que hacemos es crear un <span style="font-weight: bold;">método</span> de tipo <span style="font-weight: bold;">personas</span> que recibirá el <span style="font-weight: bold;">id</span> como parámetro y luego haciendo uso de<span style="font-weight: bold;"> linq</span> recuperamos el registro y le asignamos a cada propiedad de nuestra clase persona los datos obtenidos en la consulta y por ultimo retornamos los datos.<br /><br /><span style="font-weight: bold;">Eso seria todo en nuestra clase  datos.</span><br /><br />Ahora pasemos a diseñar nuestros formularios para este caso serán <span style="font-weight: bold;">3</span> el <span style="font-weight: bold;">principal</span> que sera donde se mostraran los datos en un <span style="font-weight: bold;">datagrid</span> ademas se podrá hacer la <span style="font-weight: bold;">búsqueda</span> de registros y tendrá <span style="font-weight: bold;">3 botones</span> que serán para agregar editar y eliminar un registro.<br /><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pjuPuWqLx-cXVoEgVIOSovLDwIY-Gqj8LTFL-Zq_fIsfFj5hHwW4cXUgLosFj8iCeaHzCMHlrMtsOalSwZtndoA/4.jpg?psid=1" alt="Principal" width="550" /><br /></div><br />También creamos los formulario que nos servirán para <span style="font-weight: bold;">agregar</span> y <span style="font-weight: bold;">editar</span> los registros.<br /><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pCu7hX4g9707LaSO0FTRznL4bL7_AjebTu9qid64fcGw0ypcgLZ8h-Y0OS74bp-z-p7StUcouEhyIHkFAbM_iAg/5.jpg?psid=1" alt="Agregar" width="550" /><br /></div><br /><div style="text-align: center;"><img src="https://public.blu.livefilestore.com/y1pZmuJG-wHqQgCY6jxRzFRLKCi_x7Qk-5_M6L5iTaONWK31NuiLE9BQJTyqYLkVPC7Odq-zkLT8HsiaqM4McXg-Q/6.jpg?psid=1" alt="Editar" width="550" /><br /></div><br />Ahora empezaremos a programar en nuestros formularios empecemos con el <span style="font-weight: bold;">form1</span> o formulario principal, comenzaremos con el código que nos servirá para <span style="font-weight: bold;">cargar</span> los datos y hacer la <span style="font-weight: bold;">búsqueda</span>.<br /><pre class="brush: csharp">public void cargar()<br />      {<br />          dataGridView1.DataSource = Datos.CargarDatos();<br />      }<br /><br />      private void Form1_Load(object sender, EventArgs e)<br />      {<br />          cargar();<br />      }<br /><br />      private void btnbuscar_Click(object sender, EventArgs e)<br />      {<br />          dataGridView1.DataSource = Datos.Buscar(txtnombre.Text);<br />      }</pre><br /><pre class="brush: vbnet">Public Sub cargar()<br />      dataGridView1.DataSource = Datos.CargarDatos()<br />  End Sub<br /><br />  Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load<br />      cargar()<br />  End Sub<br /><br />  Private Sub btnbuscar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnbuscar.Click<br />      dataGridView1.DataSource = Datos.Buscar(txtnombre.Text)<br />  End Sub</pre><br />El código es sencillo y fácil de entender así que no entrare en mayor explicación primero creamos un <span style="font-weight: bold;">método</span> donde se cargan los <span style="font-weight: bold;">datos</span> y luego en el<span style="font-weight: bold;"> evento load</span> cargamos los datos y luego en el <span style="font-weight: bold;">evento</span> del<span style="font-weight: bold;"> botón</span> buscar llamamos el <span style="font-weight: bold;">método</span> buscar y le enviamos el parámetro para obtener los datos.<br /><br />Ahora veamos como <span style="font-weight: bold;">agregar</span> un nuevo registro.<br /><pre class="brush: csharp">//cargar datos al cerrar form agregarregistro y actualizar<br />      private void obj_FormClosed(object sender, FormClosedEventArgs e)<br />      {<br />          cargar();<br />      }<br /><br />      private void btnagregar_Click(object sender, EventArgs e)<br />      {<br />          Form2 obj = new Form2();<br />          //abrir el otro formulario y actualizar datagrid al cerrarlo<br />          obj.FormClosed += new System.Windows.Forms.FormClosedEventHandler(obj_FormClosed);<br />          obj.Show();<br />      }</pre><br /><pre class="brush: vbnet">'cargar datos al cerrar form agregarregistro y actualizar<br />  Private Sub obj_FormClosed(ByVal sender As Object, ByVal e As FormClosedEventArgs)<br />      cargar()<br />  End Sub<br /><br />  Private Sub btnagregar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnagregar.Click<br />      Dim obj As New Form2()<br />      'abrir el otro formulario y actualizar datagrid al cerrarlo<br />      AddHandler obj.FormClosed, New System.Windows.Forms.FormClosedEventHandler(AddressOf obj_FormClosed)<br />      obj.Show()<br />  End Sub</pre><br />Vemos que primero creamos un<span style="font-weight: bold;"> método</span> que nos servirá para detectar el cierre tanto del formulario para agregar registro como el de editar esto lo hacemos para actualizar los datos siempre que hagamos cambios desde los 2 formularios, luego en el <span style="font-weight: bold;">evento</span> del <span style="font-weight: bold;">botón</span> llamamos al <span style="font-weight: bold;">form2</span> que es donde agregamos un nuevo registro.<br /><br />Ahora veamos como <span style="font-weight: bold;">editamos</span> y <span style="font-weight: bold;">eliminamos</span> un registro.<br /><pre class="brush: csharp">private void btneditar_Click(object sender, EventArgs e)<br />      {<br />          DataGridViewRow row = dataGridView1.CurrentRow;<br />          int id = Convert.ToInt32(row.Cells[0].Value);<br /><br />          Form3 obj = new Form3(id);<br />          obj.FormClosed += new System.Windows.Forms.FormClosedEventHandler(obj_FormClosed);<br />          obj.Show();<br /><br />      }<br /><br />      private void btneliminar_Click(object sender, EventArgs e)<br />      {<br />          DialogResult resul = MessageBox.Show("Seguro que quiere eliminar el Registro?", "Eliminar Registro", MessageBoxButtons.YesNo);<br />          if (resul == DialogResult.Yes)<br />          {<br />              DataGridViewRow row = dataGridView1.CurrentRow;<br />              int idpersona = Convert.ToInt32(row.Cells[0].Value);<br />              Datos.Eliminar(idpersona);<br />              MessageBox.Show("Se Elimino el Registro Con Numero ID: " + idpersona, "Eliminar Registro");<br />              cargar();<br />          }<br />      }</pre><br /><pre class="brush: vbnet">Private Sub btneditar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btneditar.Click<br />      Dim row As DataGridViewRow = dataGridView1.CurrentRow<br />      Dim id As Integer = Convert.ToInt32(row.Cells(0).Value)<br /><br />      Dim obj As New Form3(id)<br />      AddHandler obj.FormClosed, New System.Windows.Forms.FormClosedEventHandler(AddressOf obj_FormClosed)<br />      obj.Show()<br />  End Sub<br /><br />  Private Sub btneliminar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btneliminar.Click<br />      Dim resul As DialogResult = MessageBox.Show("Seguro que quiere eliminar el Registro?", "Eliminar Registro", MessageBoxButtons.YesNo)<br />      If resul = DialogResult.Yes Then<br />          Dim row As DataGridViewRow = dataGridView1.CurrentRow<br />          Dim idpersona As Integer = Convert.ToInt32(row.Cells(0).Value)<br />          Datos.Eliminar(idpersona)<br />          MessageBox.Show("Se Elimino el Registro Con Numero ID: " &amp; idpersona, "Eliminar Registro")<br />          cargar()<br />      End If<br />  End Sub</pre><br />En el <span style="font-weight: bold;">evento click</span> de <span style="font-weight: bold;">botón</span> editar igual que el anterior abrimos el <span style="font-weight: bold;">form3</span> que es el que nos servirá para editar los registros y actualizamos los datos al cerrarlo, algo importante es que al  <span style="font-weight: bold;">form3</span> le enviamos el id del registro a editar.<br /><br />Y en el <span style="font-weight: bold;">evento</span> del <span style="font-weight: bold;">botón</span> eliminar lo único que hacemos es <span style="font-weight: bold;">eliminar</span> el registro seleccionado en el datagrid pasandole como parametro el id del registro seleccionado a nuestro metodo eliminar.<br /><br /><span style="font-weight: bold;">Ahora pasamos al código del form2 que es en el que agregamos los registros.</span><br /><pre class="brush: csharp"><br />        private void btnaceptar_Click(object sender, EventArgs e)<br />        {<br />            DataAcces.Datos.Agregar(txtnombre.Text,txtapellido.Text,Convert.ToInt32(txtedad.Text),cbbprofesion.SelectedItem.ToString());<br />            MessageBox.Show("Registro Agregado...","Agregar Registro");<br />            this.Close();<br />        }</pre><br /><pre class="brush: vbnet">Private Sub btnaceptar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnaceptar.Click<br />      DataAcces.Datos.Agregar(txtnombre.Text, txtapellido.Text, Convert.ToInt32(txtedad.Text), cbbprofesion.SelectedItem.ToString())<br />      MessageBox.Show("Registro Agregado...", "Agregar Registro")<br />      Me.Close()<br />  End Sub</pre><br />Aquí lo único que hacemos es llamar al metodo<span style="font-weight: bold;"> agregar</span> y le enviamos los datos necesarios para agregar un registro.<br /><br /><span style="font-weight: bold;">Y por ultimo en nuestro form3 tendremos el siguiente codigo.</span><br /><pre class="brush: csharp">private int id;<br />      public Form3(int idempleado)<br />      {<br />          InitializeComponent();<br />          id = idempleado;<br />      }<br /><br />      private void Form3_Load(object sender, EventArgs e)<br />      {<br />          // se carga el registro que se quiere editar<br />           cbbprofesion.SelectedIndex = 0;<br />           Personas persona = Datos.ObtenerId(id);<br />           id = persona.Id;<br />           txtnombre.Text = persona.Nombre;<br />           txtapellido.Text = persona.Apellido;<br />           txtedad.Text = persona.Edad.ToString();         <br />      }<br /><br />      private void btnaceptar_Click(object sender, EventArgs e)<br />      {<br />          Datos.Editar(id,txtnombre.Text,txtapellido.Text,Convert.ToInt32(txtedad.Text),cbbprofesion.SelectedItem.ToString());<br />          MessageBox.Show("Registro Actualizado...", "Actualizar Registro");<br />          this.Close();<br />      }</pre><br /><pre class="brush: vbnet">Private id As Integer<br />  Public Sub New(ByVal idempleado As Integer)<br />      InitializeComponent()<br />      id = idempleado<br />  End Sub<br /><br />  Private Sub Form3_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load<br />      ' se carga el registro que se quiere editar<br />      cbbprofesion.SelectedIndex = 0<br />      Dim persona As Personas = Datos.ObtenerId(id)<br />      id = persona.Id<br />      txtnombre.Text = persona.Nombre<br />      txtapellido.Text = persona.Apellido<br />      txtedad.Text = persona.Edad.ToString()<br />  End Sub<br /><br />  Private Sub btnaceptar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnaceptar.Click<br />      Datos.Editar(id, txtnombre.Text, txtapellido.Text, Convert.ToInt32(txtedad.Text), cbbprofesion.SelectedItem.ToString())<br />      MessageBox.Show("Registro Actualizado...", "Actualizar Registro")<br />      Me.Close()<br />  End Sub</pre><br />Aqui lo que hacemos es primeramente <span style="font-weight: bold;">obtener</span> los datos del registro a <span style="font-weight: bold;">editar</span> en el <span style="font-weight: bold;">evento load</span> eso lo hacemos con el metodo <span style="font-weight: bold;">ObtenerId</span> y le enviamos como parametro el dato recibido del formulario principal.<br /><br />Y en el <span style="font-weight: bold;">evento</span> del <span style="font-weight: bold;">boton</span> llamamos a nuestro metodo Editar y le enviamos los parametros para editar el registro.<br /><br /><span style="font-weight: bold;">Bueno eso es todo por ahora, como podemos notar usar entity framework y linq nos facilita el trabajo para trabajar con bases de datos.</span><br /><center><br /><img src="https://public.blu.livefilestore.com/y1pY_fGN7B5b7b7Vrut-tjPWtowuI6yOreiAC2q_DGiWD-Mibth3fy4KL8A9QLBCtTaxGxu7K1yNC7cmAJoJeBhyQ/7.jpg?psid=1" alt="Corriendo" /><br /><br />
